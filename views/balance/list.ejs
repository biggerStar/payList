<!DOCTYPE html>
<html>
   <head>
      <title>Bootstrap 模板</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <!-- 引入 Bootstrap -->
      <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
      <script src="../javascripts/echarts.min.js"></script> 
      <!-- HTML5 Shiv 和 Respond.js 用于让 IE8 支持 HTML5元素和媒体查询 -->
      <!-- 注意： 如果通过 file://  引入 Respond.js 文件，则该文件无法起效果 -->
      <!--[if lt IE 9]>
         <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
         <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
      <![endif]-->
      <script>
        function changeUser(obj){
         var year=$("#select_year").val()
         var user_jing = $("#jing").prop('checked');
         var user_dong = $("#dong").prop('checked');
        window.location.href='/balance/list?&year='+year+"&dong_selected="+user_dong+"&jing_selected="+user_jing;
        }
    </script>
   </head>
   <body>
        <div class="container">
	<div class="row clearfix">
		<div class="col-md-12 column">
            <nav class="navbar navbar-default navbar-inverse" role="navigation">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>
                    <a class="navbar-brand" href="/">首页</a>
                    <ul class="navbar-brand">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">支出</a>
                            <ul class="dropdown-menu">
                                <li class="navbar-brand"><a href="/paylist/list">看一眼</a></li>
                                <li class="navbar-brand"><a href="/paylist/add">记一笔</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-brand">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">收入<strong class="caret"></strong></a>
                            <ul class="dropdown-menu">
                                <li class="navbar-brand"><a href="/income/list">看一眼</a></li>
                                <li class="navbar-brand"><a href="/income/add">记一笔</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-brand">
                        <li class="dropdown">
                            <a href="/balance/list" class="dropdown-toggle" data-toggle="">统计<strong class="caret"></strong></a>
                        </li>
                    </ul>

                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                    <li>
                        <a href="/logout">退出</a>
                    </li>
                    </ul>
                </div>
            </nav>
<div class="col-md-12 column">
    <select id="select_year" class="selectpicker show-tick"  data-width="200px" data-live-search="true" id="select1" onchange="selectOnchang(this)">
        <option value="<%=select_year %>" selected="selected"><%=select_year %></option>
        <% years.forEach(function(year) {%>
        <% if(year!=select_year){%>
        <option value="<%=year %>"><%=year %></option>
        <%}%>
        <% }) %>
        <option value="all">全部</option>
    </select>
    <label> 年 </label>
        <div class="checkbox">
            <label><input type="checkbox" id="dong" value="dong" <% if(selected_dong=="true"){ %> checked="checked"<% }%> onclick="changeUser(this)" />冬</label>
              <label><input type="checkbox" id="jing" name="jing" value="jing" <% if(selected_jing=="true"){ %> checked="checked"<% }%> onclick="changeUser(this)"/>宝</label>
         </div>
    <hr />
    <div class="tabbable" id="tabs-967670">
        </div>
        <div class="tab-pane" id="display" data-toggle="tab">
        <div id="main" style="width:400px;height:600px;">
<script type="text/javascript">
        // 基于准备好的dom，初始化echarts实例
var myChart = echarts.init(document.getElementById('main'));
var data = genData();

var colors = ['#5793f3', '#d14a61', '#675bba'];
option = {
    color: colors,
    tooltip: {
        trigger: 'none',
        axisPointer: {
            type: 'cross'
        }
    },
    title : {
        text: '收入:'+data.income_total + '  \n支出:' + data.pay_total,
        subtext:'',
        x:'left'
    },
    legend: {
        x:'center',
        data:['收入','支出'] 
    },
    grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
    },
    xAxis: [
        {
            type: 'category',
            axisTick: {
                alignWithLabel: true
            },
            axisLine: {
                onZero: false,
                lineStyle: {
                    color: colors[1]
                }
            },
            axisPointer: {
                label: {
                    formatter: function (params) {
                        return '收入 ' 
                            + (params.seriesData.length ? '：' + params.seriesData[0].data : '');
                    }
                }
            },
            data: data.mounth
        },
        {
            type: 'category',
            axisTick: {
                alignWithLabel: true
            },
            axisLine: {
                onZero: false,
                lineStyle: {
                    color: colors[0]
                }
            },
            axisPointer: {
                label: {
                    formatter: function (params) {
                        return '支出 ' 
                            + (params.seriesData.length ? '：' + params.seriesData[0].data : '');
                    }
                }
            },
            data: data.mounth
        }
    ],
    yAxis: [
        {
            type: 'value'
        }
    ],
    series: [
        {
            name:'收入',
            type:'line',
            data: data.income_list
        },
        {
            name:'支出',
            type:'line',
            xAxisIndex: 1,
            data: data.paylist_list
        }] 
        };

function decode(text)
{ 
    var temp = document.createElement("div"); 
    temp.innerHTML = text; 
    var output = temp.innerText || temp.textContent; 
    temp = null; 
    return output; 
} 
function genData() {
    var income= JSON.parse(<%-display_income%>);
    var paylist= JSON.parse(<%-display_paylist%>);
    var mounth_list= [];
    var income_list= [];
    var pay_list= [];
    
    var income_map = new Map();
    income.map(x => {x.time = x.time.substring(0, x.time.lastIndexOf("-"));return x}).forEach(list =>{
        var time = list.time
        if(income_map.has(time)) {
            var value = income_map.get(time) + list.money;
            income_map.set(time, value);
        } else {
            income_map.set(time, list.money);
        }
    });
    var pay_map = new Map()
    paylist.map(x => {x.time = x.time.substring(0, x.time.lastIndexOf("-"));return x}).forEach(function(list){
        var time = list.time
        if(pay_map.has(time)) {
            var value = pay_map.get(time) + list.money;
            pay_map.set(time, value);
        } else {
            pay_map.set(time, list.money);
        }
    });
    
    var income_total=0;
    income_map.forEach(function(v,key,this_map){
        income_list.push(v);
        income_total += v;
    });

    var pay_total=0;
    pay_map.forEach(function(v,key,this_map){
        mounth_list.push(key);
        pay_list.push(v);
        pay_total += v;
    });
       return {
        mounth: mounth_list,
        paylist_list: pay_list,
        income_list: income_list,
        income_total:income_total.toString(),
        pay_total:pay_total.toString()
    };
}
myChart.setOption(option);
</script>
        </div> 
        </div>
        </div>
		</div>
        </div>
        </div>
        </div>
            <!-- jQuery (Bootstrap 的 JavaScript 插件需要引入 jQuery) -->
      <script src="https://code.jquery.com/jquery.js"></script>
      <!-- 包括所有已编译的插件 -->
      <script src="../javascripts/bootstrap.min.js"></script>
  <script src="../javascripts/jquery.js"></script>
    <script>
    function selectOnchang(obj){  
     //获取被选中的option标签选项 
        var year=$("#select_year").val()
        window.location.href='/balance/list?&year='+year
    }

    function selectUser(obj){
        var jing=$("#jing").val()
        var dong=$("#dong").val()
        var mounth = obj.options[obj.selectedIndex].value;
        var year=$("#select_year").val()
        window.location.href='/balance/list?&year='+year+"&dong_selected=true&jing_selected=true";
    };
    </script>
   </body>
</html>
